---
title: "Client Usage"
description: "Build AI agents that automatically pay for API access"
---

# Client Usage

The client SDK enables AI agents and applications to automatically handle x402 payments when calling paid APIs.

## Create Client Instance

```typescript
import { create402Client } from '@402cat/sdk/client';
import { ethers } from 'ethers';

// Create wallet from private key
const wallet = new ethers.Wallet(process.env.PRIVATE_KEY!);

const client = create402Client({
  wallet,
  maxAmount: 1.00,              // Max $1 per request
  referrer: '@youragent',       // Optional: your referrer handle
  network: 'base-sepolia',      // Network preference
});
```

## Automatic Payment Handling

The client's `fetch()` method automatically handles 402 responses:

```typescript
// This automatically:
// 1. Makes initial request
// 2. Receives 402 Payment Required
// 3. Signs EIP-3009 authorization
// 4. Retries with PAYMENT-SIGNATURE header
// 5. Returns final response

const response = await client.fetch('https://api.example.com/generate', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ prompt: 'Hello world' }),
});

const data = await response.json();
console.log(data);
```

## Client Options

```typescript
interface ClientOptions {
  // Required
  wallet: ethers.Wallet;           // Wallet for signing

  // Optional
  maxAmount?: number;              // Max USD per request (default: 10)
  referrer?: string;               // Your referrer handle
  network?: string;                // Preferred network
  autoApprove?: boolean;           // Skip approval prompt (default: true)
  verbose?: boolean;               // Enable debug logging
}
```

## Balance Checking

```typescript
// Check USDC balance
const balance = await client.getBalance();
console.log(`USDC Balance: $${balance.toFixed(2)}`);

// Check if can afford a request
if (balance < 0.10) {
  console.log('Insufficient balance');
}
```

## Manual Payment Flow

For more control over the payment process:

```typescript
import { parsePaymentRequired, signPayment } from '@402cat/sdk/client';

// 1. Make initial request
const response = await fetch('https://api.example.com/service');

if (response.status === 402) {
  // 2. Parse payment requirements
  const header = response.headers.get('PAYMENT-REQUIRED');
  const requirements = parsePaymentRequired(header);

  console.log('Payment required:', {
    amount: requirements.accepts[0].maxAmountRequired,
    payTo: requirements.accepts[0].payTo,
  });

  // 3. User confirms (optional)
  const confirmed = await confirmWithUser(requirements);

  if (confirmed) {
    // 4. Sign payment
    const signature = await signPayment(wallet, requirements.accepts[0]);

    // 5. Retry with payment
    const paidResponse = await fetch('https://api.example.com/service', {
      headers: {
        'PAYMENT-SIGNATURE': signature,
      },
    });

    return paidResponse.json();
  }
}
```

## Referral Header

To earn referral fees when your agent calls other APIs:

```typescript
const client = create402Client({
  wallet,
  referrer: '@youragent',  // Your registered handle
});

// All requests include X-402-Referrer header automatically
const response = await client.fetch('https://other-api.com/service');
```

Or set per-request:

```typescript
const response = await client.fetch('https://api.example.com/service', {
  headers: {
    'X-402-Referrer': '@myagent',
  },
});
```

## Error Handling

```typescript
try {
  const response = await client.fetch('https://api.example.com/service');
  const data = await response.json();
} catch (error) {
  if (error.code === 'INSUFFICIENT_BALANCE') {
    console.log('Not enough USDC');
  } else if (error.code === 'PAYMENT_FAILED') {
    console.log('Payment settlement failed:', error.message);
  } else if (error.code === 'MAX_AMOUNT_EXCEEDED') {
    console.log('Request exceeds max amount limit');
  } else {
    throw error;
  }
}
```

## React Hook

For browser applications:

```typescript
import { usePayment } from '@402cat/sdk/react';
import { useAccount, useWalletClient } from 'wagmi';

function PayButton() {
  const { address } = useAccount();
  const { data: walletClient } = useWalletClient();

  const {
    fetch,
    isLoading,
    error,
    balance,
    lastTxHash,
  } = usePayment({
    wallet: walletClient,
    maxAmount: 1.00,
  });

  const handleClick = async () => {
    const response = await fetch('https://api.example.com/generate', {
      method: 'POST',
      body: JSON.stringify({ prompt: 'Hello' }),
    });
    const data = await response.json();
    console.log(data);
  };

  return (
    <div>
      <p>Balance: ${balance?.toFixed(2) ?? '...'}</p>
      <button onClick={handleClick} disabled={isLoading}>
        {isLoading ? 'Paying...' : 'Generate ($0.05)'}
      </button>
      {lastTxHash && (
        <a href={`https://basescan.org/tx/${lastTxHash}`}>View TX</a>
      )}
      {error && <p className="error">{error.message}</p>}
    </div>
  );
}
```

## Agent Example

Complete AI agent that calls a paid API:

```typescript
import { create402Client } from '@402cat/sdk/client';
import { ethers } from 'ethers';

async function main() {
  // Setup client
  const wallet = new ethers.Wallet(process.env.AGENT_PRIVATE_KEY!);
  const client = create402Client({
    wallet,
    maxAmount: 5.00,
    referrer: '@myagent',
  });

  // Check balance
  const balance = await client.getBalance();
  console.log(`Starting balance: $${balance.toFixed(2)}`);

  // Call paid API
  const response = await client.fetch('https://api.402.cat/entrypoints/token_buy/invoke', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      token_address: '0x...',
      amount_usdc: 1000000,  // $1.00
    }),
  });

  const result = await response.json();
  console.log('Purchase result:', result);

  // Check new balance
  const newBalance = await client.getBalance();
  console.log(`Ending balance: $${newBalance.toFixed(2)}`);
}

main();
```

## Next Steps

<CardGroup cols={2}>
  <Card title="Referrals" icon="share" href="/sdk/referrals">
    Earn fees when your agent refers others
  </Card>
  <Card title="Examples" icon="code" href="/sdk/examples">
    Complete example projects
  </Card>
</CardGroup>
